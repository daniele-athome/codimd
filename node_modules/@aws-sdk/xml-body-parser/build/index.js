"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var protocol_timestamp_1 = require("@aws-sdk/protocol-timestamp");
var pixl_xml_1 = require("../vendor/pixl-xml");
var XmlBodyParser = /** @class */ (function () {
    function XmlBodyParser(base64Decoder) {
        this.base64Decoder = base64Decoder;
    }
    XmlBodyParser.prototype.parse = function (member, input) {
        var _a;
        var xmlObj = pixl_xml_1.parse(input, {
            preserveAttributes: true
        });
        var wrappedShape = member.shape;
        if (member.resultWrapper) {
            wrappedShape = {
                type: "structure",
                required: [],
                members: (_a = {},
                    _a[member.resultWrapper] = {
                        shape: member.shape
                    },
                    _a)
            };
        }
        var data = this.unmarshall(wrappedShape, xmlObj);
        if (member.resultWrapper) {
            data = data[member.resultWrapper];
        }
        //standard query
        if (xmlObj.ResponseMetadata && xmlObj.ResponseMetadata.RequestId) {
            data.$metadata = {
                requestId: xmlObj.ResponseMetadata.RequestId
            };
        }
        //ec2 query
        if (xmlObj.RequestId) {
            data.$metadata = {
                requestId: xmlObj.RequestId
            };
        }
        //SDB query
        if (xmlObj.RequestID) {
            data.$metadata = {
                requestId: xmlObj.RequestID
            };
        }
        return data;
    };
    XmlBodyParser.prototype.unmarshall = function (shape, xmlObj) {
        if (shape.type === "structure") {
            return this.parseStructure(shape, xmlObj);
        }
        else if (shape.type === "list") {
            return this.parseList(shape, xmlObj);
        }
        else if (shape.type === "map") {
            return this.parseMap(shape, xmlObj);
        }
        else if (shape.type === "timestamp") {
            return this.parseTimeStamp(shape, xmlObj);
        }
        else if (shape.type === "blob") {
            return typeof xmlObj === "string"
                ? this.base64Decoder(xmlObj)
                : undefined;
        }
        else if (shape.type === "boolean") {
            if (!xmlObj)
                return undefined;
            return xmlObj === "true";
        }
        else if (shape.type === "float" || shape.type === "integer") {
            if (!xmlObj) {
                return undefined;
            }
            var num = Number(xmlObj);
            return isFinite(num) ? num : undefined;
        }
        else if (shape.type === "string") {
            if (xmlObj === "") {
                return xmlObj;
            }
            return xmlObj ? xmlObj.toString() : undefined;
        }
        else {
            throw new Error(shape.type + " can not be parsed");
        }
    };
    XmlBodyParser.prototype.parseStructure = function (shape, xmlObj) {
        var e_1, _a;
        if (xmlObj === undefined) {
            return undefined;
        }
        var obj = {};
        try {
            for (var _b = tslib_1.__values(Object.keys(shape.members)), _c = _b.next(); !_c.done; _c = _b.next()) {
                var memberName = _c.value;
                var member = shape.members[memberName];
                var xmlKey = this.mapToXMLKey(member, memberName);
                var subXmlObj = xmlObj;
                if (member.xmlAttribute) {
                    subXmlObj = xmlObj["_Attribs"];
                }
                obj[memberName] = this.unmarshall(member.shape, subXmlObj[xmlKey]);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_c && !_c.done && (_a = _b.return)) _a.call(_b);
            }
            finally { if (e_1) throw e_1.error; }
        }
        return obj;
    };
    XmlBodyParser.prototype.mapToXMLKey = function (member, name) {
        var keyName = member.locationName || name, membershape = member.shape;
        if (membershape.type === "list") {
            keyName = membershape.flattened
                ? membershape.member.locationName || keyName
                : keyName;
        }
        return keyName;
    };
    XmlBodyParser.prototype.parseList = function (shape, xmlObj) {
        var e_2, _a;
        var list = [], xmlList = xmlObj;
        if (!xmlObj || Object.keys(xmlObj).length === 0) {
            return list;
        }
        if (!Array.isArray(xmlObj)) {
            var key = shape.member.locationName || "member";
            xmlList = shape.flattened ? xmlObj : xmlObj[key];
            if (!xmlList || Object.keys(xmlList).length === 0) {
                return list;
            }
            if (!Array.isArray(xmlList)) {
                xmlList = [xmlList];
            }
        }
        try {
            for (var xmlList_1 = tslib_1.__values(xmlList), xmlList_1_1 = xmlList_1.next(); !xmlList_1_1.done; xmlList_1_1 = xmlList_1.next()) {
                var xmlObjEntry = xmlList_1_1.value;
                list.push(this.unmarshall(shape.member.shape, xmlObjEntry));
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (xmlList_1_1 && !xmlList_1_1.done && (_a = xmlList_1.return)) _a.call(xmlList_1);
            }
            finally { if (e_2) throw e_2.error; }
        }
        return list;
    };
    XmlBodyParser.prototype.parseMap = function (shape, xmlObj) {
        var e_3, _a;
        var obj = {}, mapEntryList = xmlObj;
        if (!shape.flattened) {
            mapEntryList = xmlObj["entry"];
        }
        if (!mapEntryList || Object.keys(mapEntryList).length === 0) {
            return {};
        }
        if (!Array.isArray(mapEntryList)) {
            mapEntryList = [mapEntryList];
        }
        try {
            for (var mapEntryList_1 = tslib_1.__values(mapEntryList), mapEntryList_1_1 = mapEntryList_1.next(); !mapEntryList_1_1.done; mapEntryList_1_1 = mapEntryList_1.next()) {
                var mapEntry = mapEntryList_1_1.value;
                var keyName = shape.key.locationName || "key";
                var valueName = shape.value.locationName || "value";
                obj[mapEntry[keyName]] = this.unmarshall(shape.value.shape, mapEntry[valueName]);
            }
        }
        catch (e_3_1) { e_3 = { error: e_3_1 }; }
        finally {
            try {
                if (mapEntryList_1_1 && !mapEntryList_1_1.done && (_a = mapEntryList_1.return)) _a.call(mapEntryList_1);
            }
            finally { if (e_3) throw e_3.error; }
        }
        return obj;
    };
    XmlBodyParser.prototype.parseTimeStamp = function (shape, xmlObj) {
        if (!xmlObj) {
            return undefined;
        }
        var date = protocol_timestamp_1.toDate(xmlObj);
        if (date.toString() === "Invalid Date") {
            return undefined;
        }
        return date;
    };
    return XmlBodyParser;
}());
exports.XmlBodyParser = XmlBodyParser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsa0VBQXFEO0FBQ3JELCtDQUF3RTtBQTZCeEU7SUFDRSx1QkFBNkIsYUFBc0I7UUFBdEIsa0JBQWEsR0FBYixhQUFhLENBQVM7SUFBRyxDQUFDO0lBRWhELDZCQUFLLEdBQVosVUFBeUIsTUFBYyxFQUFFLEtBQWE7O1FBQ3BELElBQUksTUFBTSxHQUFtQixnQkFBUyxDQUFDLEtBQUssRUFBRTtZQUM1QyxrQkFBa0IsRUFBRSxJQUFJO1NBQ3pCLENBQUMsQ0FBQztRQUNILElBQUksWUFBWSxHQUF1QixNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ3BELElBQUksTUFBTSxDQUFDLGFBQWEsRUFBRTtZQUN4QixZQUFZLEdBQUc7Z0JBQ2IsSUFBSSxFQUFFLFdBQVc7Z0JBQ2pCLFFBQVEsRUFBRSxFQUFFO2dCQUNaLE9BQU87b0JBQ0wsR0FBQyxNQUFNLENBQUMsYUFBYSxJQUFHO3dCQUN0QixLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUs7cUJBQ3BCO3VCQUNGO2FBQ0YsQ0FBQztTQUNIO1FBQ0QsSUFBSSxJQUFJLEdBQWUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDN0QsSUFBSSxNQUFNLENBQUMsYUFBYSxFQUFFO1lBQ3hCLElBQUksR0FBSSxJQUFZLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQzVDO1FBQ0QsZ0JBQWdCO1FBQ2hCLElBQUksTUFBTSxDQUFDLGdCQUFnQixJQUFJLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUU7WUFDL0QsSUFBWSxDQUFDLFNBQVMsR0FBRztnQkFDeEIsU0FBUyxFQUFFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTO2FBQzdDLENBQUM7U0FDSDtRQUNELFdBQVc7UUFDWCxJQUFJLE1BQU0sQ0FBQyxTQUFTLEVBQUU7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MENBQUEsb0VBQUU7Z0JBQTlCLElBQUksUUFBUSx5QkFBQTtnQkFDZixJQUFJLE9BQU8sR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLFlBQVksSUFBSSxLQUFLLENBQUM7Z0JBQzlDLElBQUksU0FBUyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsWUFBWSxJQUFJLE9BQU8sQ0FBQztnQkFDcEQsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQ3RDLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUNqQixRQUFRLENBQUMsU0FBUyxDQUFDLENBQ3BCLENBQUM7YUFDSDs7Ozs7Ozs7O1FBQ0QsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDO0lBRU8sc0NBQWMsR0FBdEIsVUFDRSxLQUFnQixFQUNoQixNQUFXO1FBRVgsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNYLE9BQU8sU0FBUyxDQUFDO1NBQ2xCO1FBQ0QsSUFBSSxJQUFJLEdBQUcsMkJBQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMxQixJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsS0FBSyxjQUFjLEVBQUU7WUFDdEMsT0FBTyxTQUFTLENBQUM7U0FDbEI7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFDSCxvQkFBQztBQUFELENBQUMsQUFyS0QsSUFxS0M7QUFyS1ksc0NBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB0b0RhdGUgfSBmcm9tIFwiQGF3cy1zZGsvcHJvdG9jb2wtdGltZXN0YW1wXCI7XG5pbXBvcnQgeyBwYXJzZSBhcyBwaXhsUGFyc2UsIFhNTFBhcnNlT3V0cHV0IH0gZnJvbSBcIi4uL3ZlbmRvci9waXhsLXhtbFwiO1xuaW1wb3J0IHtcbiAgQm9keVBhcnNlcixcbiAgRGVjb2RlcixcbiAgTWVtYmVyLFxuICBTaGFwZSxcbiAgU3RydWN0dXJlLFxuICBMaXN0LFxuICBNYXAsXG4gIEJvb2xlYW4sXG4gIEJsb2IsXG4gIFRpbWVzdGFtcCxcbiAgU2VyaWFsaXphdGlvbk1vZGVsXG59IGZyb20gXCJAYXdzLXNkay90eXBlc1wiO1xuXG50eXBlIFNjYWxhciA9IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBudWxsO1xuXG5pbnRlcmZhY2UgT2JqZWN0VHlwZSB7XG4gIFtrZXk6IHN0cmluZ106IE9iamVjdFR5cGUgfCBTY2FsYXIgfCBPYmplY3RUeXBlQXJyYXk7XG59XG5cbmludGVyZmFjZSBQYXJzZWRSZXNwb25zZSBleHRlbmRzIFhNTFBhcnNlT3V0cHV0IHtcbiAgUmVzcG9uc2VNZXRhZGF0YTogeyBSZXF1ZXN0SWQ6IHN0cmluZyB9O1xuICBSZXF1ZXN0SWQ/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBPYmplY3RUeXBlQXJyYXlcbiAgZXh0ZW5kcyBBcnJheTxPYmplY3RUeXBlIHwgU2NhbGFyIHwgT2JqZWN0VHlwZUFycmF5PiB7fVxuXG5leHBvcnQgY2xhc3MgWG1sQm9keVBhcnNlciBpbXBsZW1lbnRzIEJvZHlQYXJzZXIge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGJhc2U2NERlY29kZXI6IERlY29kZXIpIHt9XG5cbiAgcHVibGljIHBhcnNlPE91dHB1dFR5cGU+KG1lbWJlcjogTWVtYmVyLCBpbnB1dDogc3RyaW5nKTogT3V0cHV0VHlwZSB7XG4gICAgbGV0IHhtbE9iaiA9IDxQYXJzZWRSZXNwb25zZT5waXhsUGFyc2UoaW5wdXQsIHtcbiAgICAgIHByZXNlcnZlQXR0cmlidXRlczogdHJ1ZVxuICAgIH0pO1xuICAgIGxldCB3cmFwcGVkU2hhcGU6IFNlcmlhbGl6YXRpb25Nb2RlbCA9IG1lbWJlci5zaGFwZTtcbiAgICBpZiAobWVtYmVyLnJlc3VsdFdyYXBwZXIpIHtcbiAgICAgIHdyYXBwZWRTaGFwZSA9IHtcbiAgICAgICAgdHlwZTogXCJzdHJ1Y3R1cmVcIixcbiAgICAgICAgcmVxdWlyZWQ6IFtdLFxuICAgICAgICBtZW1iZXJzOiB7XG4gICAgICAgICAgW21lbWJlci5yZXN1bHRXcmFwcGVyXToge1xuICAgICAgICAgICAgc2hhcGU6IG1lbWJlci5zaGFwZVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG4gICAgbGV0IGRhdGE6IE91dHB1dFR5cGUgPSB0aGlzLnVubWFyc2hhbGwod3JhcHBlZFNoYXBlLCB4bWxPYmopO1xuICAgIGlmIChtZW1iZXIucmVzdWx0V3JhcHBlcikge1xuICAgICAgZGF0YSA9IChkYXRhIGFzIGFueSlbbWVtYmVyLnJlc3VsdFdyYXBwZXJdO1xuICAgIH1cbiAgICAvL3N0YW5kYXJkIHF1ZXJ5XG4gICAgaWYgKHhtbE9iai5SZXNwb25zZU1ldGFkYXRhICYmIHhtbE9iai5SZXNwb25zZU1ldGFkYXRhLlJlcXVlc3RJZCkge1xuICAgICAgKGRhdGEgYXMgYW55KS4kbWV0YWRhdGEgPSB7XG4gICAgICAgIHJlcXVlc3RJZDogeG1sT2JqLlJlc3BvbnNlTWV0YWRhdGEuUmVxdWVzdElkXG4gICAgICB9O1xuICAgIH1cbiAgICAvL2VjMiBxdWVyeVxuICAgIGlmICh4bWxPYmouUmVxdWVzdElkKSB7XG4gICAgICAoZGF0YSBhcyBhbnkpLiRtZXRhZGF0YSA9IHtcbiAgICAgICAgcmVxdWVzdElkOiB4bWxPYmouUmVxdWVzdElkXG4gICAgICB9O1xuICAgIH1cbiAgICAvL1NEQiBxdWVyeVxuICAgIGlmICh4bWxPYmouUmVxdWVzdElEKSB7XG4gICAgICAoZGF0YSBhcyBhbnkpLiRtZXRhZGF0YSA9IHtcbiAgICAgICAgcmVxdWVzdElkOiB4bWxPYmouUmVxdWVzdElEXG4gICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4gZGF0YSBhcyBPdXRwdXRUeXBlO1xuICB9XG5cbiAgcHJpdmF0ZSB1bm1hcnNoYWxsKHNoYXBlOiBTZXJpYWxpemF0aW9uTW9kZWwsIHhtbE9iajogYW55KTogYW55IHtcbiAgICBpZiAoc2hhcGUudHlwZSA9PT0gXCJzdHJ1Y3R1cmVcIikge1xuICAgICAgcmV0dXJuIHRoaXMucGFyc2VTdHJ1Y3R1cmUoc2hhcGUsIHhtbE9iaik7XG4gICAgfSBlbHNlIGlmIChzaGFwZS50eXBlID09PSBcImxpc3RcIikge1xuICAgICAgcmV0dXJuIHRoaXMucGFyc2VMaXN0KHNoYXBlLCB4bWxPYmopO1xuICAgIH0gZWxzZSBpZiAoc2hhcGUudHlwZSA9PT0gXCJtYXBcIikge1xuICAgICAgcmV0dXJuIHRoaXMucGFyc2VNYXAoc2hhcGUsIHhtbE9iaik7XG4gICAgfSBlbHNlIGlmIChzaGFwZS50eXBlID09PSBcInRpbWVzdGFtcFwiKSB7XG4gICAgICByZXR1cm4gdGhpcy5wYXJzZVRpbWVTdGFtcChzaGFwZSwgeG1sT2JqKTtcbiAgICB9IGVsc2UgaWYgKHNoYXBlLnR5cGUgPT09IFwiYmxvYlwiKSB7XG4gICAgICByZXR1cm4gdHlwZW9mIHhtbE9iaiA9PT0gXCJzdHJpbmdcIlxuICAgICAgICA/IHRoaXMuYmFzZTY0RGVjb2Rlcih4bWxPYmopXG4gICAgICAgIDogdW5kZWZpbmVkO1xuICAgIH0gZWxzZSBpZiAoc2hhcGUudHlwZSA9PT0gXCJib29sZWFuXCIpIHtcbiAgICAgIGlmICgheG1sT2JqKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgcmV0dXJuIHhtbE9iaiA9PT0gXCJ0cnVlXCI7XG4gICAgfSBlbHNlIGlmIChzaGFwZS50eXBlID09PSBcImZsb2F0XCIgfHwgc2hhcGUudHlwZSA9PT0gXCJpbnRlZ2VyXCIpIHtcbiAgICAgIGlmICgheG1sT2JqKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgICBjb25zdCBudW0gPSBOdW1iZXIoeG1sT2JqKTtcbiAgICAgIHJldHVybiBpc0Zpbml0ZShudW0pID8gbnVtIDogdW5kZWZpbmVkO1xuICAgIH0gZWxzZSBpZiAoc2hhcGUudHlwZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgaWYgKHhtbE9iaiA9PT0gXCJcIikge1xuICAgICAgICByZXR1cm4geG1sT2JqO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHhtbE9iaiA/IHhtbE9iai50b1N0cmluZygpIDogdW5kZWZpbmVkO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7KHNoYXBlIGFzIGFueSkudHlwZX0gY2FuIG5vdCBiZSBwYXJzZWRgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHBhcnNlU3RydWN0dXJlKFxuICAgIHNoYXBlOiBTdHJ1Y3R1cmUsXG4gICAgeG1sT2JqOiBhbnlcbiAgKTogT2JqZWN0VHlwZSB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKHhtbE9iaiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBsZXQgb2JqOiBPYmplY3RUeXBlID0ge307XG4gICAgZm9yIChjb25zdCBtZW1iZXJOYW1lIG9mIE9iamVjdC5rZXlzKHNoYXBlLm1lbWJlcnMpKSB7XG4gICAgICBjb25zdCBtZW1iZXI6IE1lbWJlciA9IHNoYXBlLm1lbWJlcnNbbWVtYmVyTmFtZV07XG4gICAgICBjb25zdCB4bWxLZXkgPSB0aGlzLm1hcFRvWE1MS2V5KG1lbWJlciwgbWVtYmVyTmFtZSk7XG4gICAgICBsZXQgc3ViWG1sT2JqID0geG1sT2JqO1xuICAgICAgaWYgKG1lbWJlci54bWxBdHRyaWJ1dGUpIHtcbiAgICAgICAgc3ViWG1sT2JqID0geG1sT2JqW1wiX0F0dHJpYnNcIl07XG4gICAgICB9XG4gICAgICBvYmpbbWVtYmVyTmFtZV0gPSB0aGlzLnVubWFyc2hhbGwobWVtYmVyLnNoYXBlLCBzdWJYbWxPYmpbeG1sS2V5XSk7XG4gICAgfVxuICAgIHJldHVybiBvYmo7XG4gIH1cblxuICBwcml2YXRlIG1hcFRvWE1MS2V5KG1lbWJlcjogTWVtYmVyLCBuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGxldCBrZXlOYW1lID0gbWVtYmVyLmxvY2F0aW9uTmFtZSB8fCBuYW1lLFxuICAgICAgbWVtYmVyc2hhcGUgPSBtZW1iZXIuc2hhcGU7XG4gICAgaWYgKG1lbWJlcnNoYXBlLnR5cGUgPT09IFwibGlzdFwiKSB7XG4gICAgICBrZXlOYW1lID0gbWVtYmVyc2hhcGUuZmxhdHRlbmVkXG4gICAgICAgID8gbWVtYmVyc2hhcGUubWVtYmVyLmxvY2F0aW9uTmFtZSB8fCBrZXlOYW1lXG4gICAgICAgIDoga2V5TmFtZTtcbiAgICB9XG4gICAgcmV0dXJuIGtleU5hbWU7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlTGlzdChzaGFwZTogTGlzdCwgeG1sT2JqOiBhbnkpOiBPYmplY3RUeXBlQXJyYXkge1xuICAgIGxldCBsaXN0OiBPYmplY3RUeXBlW10gPSBbXSxcbiAgICAgIHhtbExpc3QgPSB4bWxPYmo7XG4gICAgaWYgKCF4bWxPYmogfHwgT2JqZWN0LmtleXMoeG1sT2JqKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBsaXN0O1xuICAgIH1cbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoeG1sT2JqKSkge1xuICAgICAgY29uc3Qga2V5ID0gc2hhcGUubWVtYmVyLmxvY2F0aW9uTmFtZSB8fCBcIm1lbWJlclwiO1xuICAgICAgeG1sTGlzdCA9IHNoYXBlLmZsYXR0ZW5lZCA/IHhtbE9iaiA6IHhtbE9ialtrZXldO1xuICAgICAgaWYgKCF4bWxMaXN0IHx8IE9iamVjdC5rZXlzKHhtbExpc3QpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gbGlzdDtcbiAgICAgIH1cbiAgICAgIGlmICghQXJyYXkuaXNBcnJheSh4bWxMaXN0KSkge1xuICAgICAgICB4bWxMaXN0ID0gW3htbExpc3RdO1xuICAgICAgfVxuICAgIH1cbiAgICBmb3IgKGxldCB4bWxPYmpFbnRyeSBvZiB4bWxMaXN0KSB7XG4gICAgICBsaXN0LnB1c2godGhpcy51bm1hcnNoYWxsKHNoYXBlLm1lbWJlci5zaGFwZSwgeG1sT2JqRW50cnkpKTtcbiAgICB9XG4gICAgcmV0dXJuIGxpc3Q7XG4gIH1cblxuICBwcml2YXRlIHBhcnNlTWFwKHNoYXBlOiBNYXAsIHhtbE9iajogYW55KTogT2JqZWN0VHlwZSB7XG4gICAgbGV0IG9iajogT2JqZWN0VHlwZSA9IHt9LFxuICAgICAgbWFwRW50cnlMaXN0ID0geG1sT2JqO1xuICAgIGlmICghc2hhcGUuZmxhdHRlbmVkKSB7XG4gICAgICBtYXBFbnRyeUxpc3QgPSB4bWxPYmpbXCJlbnRyeVwiXTtcbiAgICB9XG4gICAgaWYgKCFtYXBFbnRyeUxpc3QgfHwgT2JqZWN0LmtleXMobWFwRW50cnlMaXN0KS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KG1hcEVudHJ5TGlzdCkpIHtcbiAgICAgIG1hcEVudHJ5TGlzdCA9IFttYXBFbnRyeUxpc3RdO1xuICAgIH1cbiAgICBmb3IgKGxldCBtYXBFbnRyeSBvZiBtYXBFbnRyeUxpc3QpIHtcbiAgICAgIGxldCBrZXlOYW1lID0gc2hhcGUua2V5LmxvY2F0aW9uTmFtZSB8fCBcImtleVwiO1xuICAgICAgbGV0IHZhbHVlTmFtZSA9IHNoYXBlLnZhbHVlLmxvY2F0aW9uTmFtZSB8fCBcInZhbHVlXCI7XG4gICAgICBvYmpbbWFwRW50cnlba2V5TmFtZV1dID0gdGhpcy51bm1hcnNoYWxsKFxuICAgICAgICBzaGFwZS52YWx1ZS5zaGFwZSxcbiAgICAgICAgbWFwRW50cnlbdmFsdWVOYW1lXVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIG9iajtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VUaW1lU3RhbXAoXG4gICAgc2hhcGU6IFRpbWVzdGFtcCxcbiAgICB4bWxPYmo6IGFueVxuICApOiBEYXRlIHwgdW5kZWZpbmVkIHwgbnVsbCB7XG4gICAgaWYgKCF4bWxPYmopIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGxldCBkYXRlID0gdG9EYXRlKHhtbE9iaik7XG4gICAgaWYgKGRhdGUudG9TdHJpbmcoKSA9PT0gXCJJbnZhbGlkIERhdGVcIikge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGU7XG4gIH1cbn1cbiJdfQ==