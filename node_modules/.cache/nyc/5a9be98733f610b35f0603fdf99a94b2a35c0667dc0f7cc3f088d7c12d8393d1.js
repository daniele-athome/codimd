'use strict';var cov_zxu4rfsu7=function(){var path="/home/travis/build/daniele-athome/codimd/lib/realtime/realtimeUpdateDirtyNoteJob.js";var hash="5f0e9d8e5bd66031b88b8904f398670c43e1c638";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/home/travis/build/daniele-athome/codimd/lib/realtime/realtimeUpdateDirtyNoteJob.js",statementMap:{"0":{start:{line:3,column:15},end:{line:3,column:35}},"1":{start:{line:4,column:15},end:{line:4,column:35}},"2":{start:{line:5,column:15},end:{line:5,column:32}},"3":{start:{line:9,column:4},end:{line:9,column:28}},"4":{start:{line:13,column:4},end:{line:13,column:26}},"5":{start:{line:13,column:20},end:{line:13,column:26}},"6":{start:{line:14,column:4},end:{line:14,column:68}},"7":{start:{line:18,column:4},end:{line:18,column:27}},"8":{start:{line:18,column:21},end:{line:18,column:27}},"9":{start:{line:19,column:4},end:{line:19,column:29}},"10":{start:{line:20,column:4},end:{line:20,column:26}},"11":{start:{line:24,column:18},end:{line:24,column:45}},"12":{start:{line:25,column:4},end:{line:31,column:6}},"13":{start:{line:26,column:19},end:{line:26,column:29}},"14":{start:{line:27,column:6},end:{line:30,column:10}},"15":{start:{line:29,column:10},end:{line:29,column:61}},"16":{start:{line:35,column:18},end:{line:35,column:45}},"17":{start:{line:36,column:4},end:{line:36,column:36}},"18":{start:{line:36,column:30},end:{line:36,column:36}},"19":{start:{line:38,column:4},end:{line:38,column:90}},"20":{start:{line:38,column:22},end:{line:38,column:90}},"21":{start:{line:39,column:4},end:{line:39,column:31}},"22":{start:{line:41,column:4},end:{line:63,column:5}},"23":{start:{line:42,column:20},end:{line:42,column:52}},"24":{start:{line:44,column:6},end:{line:44,column:59}},"25":{start:{line:44,column:53},end:{line:44,column:59}},"26":{start:{line:46,column:6},end:{line:52,column:7}},"27":{start:{line:47,column:8},end:{line:49,column:10}},"28":{start:{line:50,column:8},end:{line:50,column:66}},"29":{start:{line:51,column:8},end:{line:51,column:50}},"30":{start:{line:54,column:6},end:{line:54,column:60}},"31":{start:{line:55,column:6},end:{line:55,column:35}},"32":{start:{line:57,column:6},end:{line:57,column:64}},"33":{start:{line:58,column:6},end:{line:60,column:8}},"34":{start:{line:61,column:6},end:{line:61,column:48}},"35":{start:{line:62,column:6},end:{line:62,column:15}},"36":{start:{line:67,column:4},end:{line:74,column:6}},"37":{start:{line:68,column:6},end:{line:73,column:8}},"38":{start:{line:69,column:8},end:{line:71,column:9}},"39":{start:{line:70,column:10},end:{line:70,column:28}},"40":{start:{line:72,column:8},end:{line:72,column:29}},"41":{start:{line:78,column:0},end:{line:78,column:47}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:8,column:2},end:{line:8,column:3}},loc:{start:{line:8,column:25},end:{line:10,column:3}},line:8},"1":{name:"(anonymous_1)",decl:{start:{line:12,column:2},end:{line:12,column:3}},loc:{start:{line:12,column:11},end:{line:15,column:3}},line:12},"2":{name:"(anonymous_2)",decl:{start:{line:17,column:2},end:{line:17,column:3}},loc:{start:{line:17,column:10},end:{line:21,column:3}},line:17},"3":{name:"(anonymous_3)",decl:{start:{line:23,column:2},end:{line:23,column:3}},loc:{start:{line:23,column:22},end:{line:32,column:3}},line:23},"4":{name:"(anonymous_4)",decl:{start:{line:25,column:31},end:{line:25,column:32}},loc:{start:{line:25,column:40},end:{line:31,column:5}},line:25},"5":{name:"(anonymous_5)",decl:{start:{line:28,column:15},end:{line:28,column:16}},loc:{start:{line:28,column:24},end:{line:30,column:9}},line:28},"6":{name:"(anonymous_6)",decl:{start:{line:34,column:2},end:{line:34,column:3}},loc:{start:{line:34,column:31},end:{line:64,column:3}},line:34},"7":{name:"(anonymous_7)",decl:{start:{line:66,column:2},end:{line:66,column:3}},loc:{start:{line:66,column:25},end:{line:75,column:3}},line:66},"8":{name:"(anonymous_8)",decl:{start:{line:67,column:23},end:{line:67,column:24}},loc:{start:{line:67,column:44},end:{line:74,column:5}},line:67},"9":{name:"(anonymous_9)",decl:{start:{line:68,column:37},end:{line:68,column:38}},loc:{start:{line:68,column:53},end:{line:73,column:7}},line:68}},branchMap:{"0":{loc:{start:{line:13,column:4},end:{line:13,column:26}},type:"if",locations:[{start:{line:13,column:4},end:{line:13,column:26}},{start:{line:13,column:4},end:{line:13,column:26}}],line:13},"1":{loc:{start:{line:18,column:4},end:{line:18,column:27}},type:"if",locations:[{start:{line:18,column:4},end:{line:18,column:27}},{start:{line:18,column:4},end:{line:18,column:27}}],line:18},"2":{loc:{start:{line:36,column:4},end:{line:36,column:36}},type:"if",locations:[{start:{line:36,column:4},end:{line:36,column:36}},{start:{line:36,column:4},end:{line:36,column:36}}],line:36},"3":{loc:{start:{line:38,column:4},end:{line:38,column:90}},type:"if",locations:[{start:{line:38,column:4},end:{line:38,column:90}},{start:{line:38,column:4},end:{line:38,column:90}}],line:38},"4":{loc:{start:{line:44,column:6},end:{line:44,column:59}},type:"if",locations:[{start:{line:44,column:6},end:{line:44,column:59}},{start:{line:44,column:6},end:{line:44,column:59}}],line:44},"5":{loc:{start:{line:44,column:10},end:{line:44,column:51}},type:"binary-expr",locations:[{start:{line:44,column:10},end:{line:44,column:25}},{start:{line:44,column:29},end:{line:44,column:51}}],line:44},"6":{loc:{start:{line:46,column:6},end:{line:52,column:7}},type:"if",locations:[{start:{line:46,column:6},end:{line:52,column:7}},{start:{line:46,column:6},end:{line:52,column:7}}],line:46},"7":{loc:{start:{line:69,column:8},end:{line:71,column:9}},type:"if",locations:[{start:{line:69,column:8},end:{line:71,column:9}},{start:{line:69,column:8},end:{line:71,column:9}}],line:69}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0,"34":0,"35":0,"36":0,"37":0,"38":0,"39":0,"40":0,"41":0},f:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0},b:{"0":[0,0],"1":[0,0],"2":[0,0],"3":[0,0],"4":[0,0],"5":[0,0],"6":[0,0],"7":[0,0]},_coverageSchema:"43e27e138ebf9cfc5966b082cf9a028302ed4184",hash:"5f0e9d8e5bd66031b88b8904f398670c43e1c638"};var coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}return coverage[path]=coverageData;}();const config=(cov_zxu4rfsu7.s[0]++,require('../config'));const logger=(cov_zxu4rfsu7.s[1]++,require('../logger'));const moment=(cov_zxu4rfsu7.s[2]++,require('moment'));class UpdateDirtyNoteJob{constructor(realtime){cov_zxu4rfsu7.f[0]++;cov_zxu4rfsu7.s[3]++;this.realtime=realtime;}start(){cov_zxu4rfsu7.f[1]++;cov_zxu4rfsu7.s[4]++;if(this.timer){cov_zxu4rfsu7.b[0][0]++;cov_zxu4rfsu7.s[5]++;return;}else{cov_zxu4rfsu7.b[0][1]++;}cov_zxu4rfsu7.s[6]++;this.timer=setInterval(this.updateDirtyNotes.bind(this),1000);}stop(){cov_zxu4rfsu7.f[2]++;cov_zxu4rfsu7.s[7]++;if(!this.timer){cov_zxu4rfsu7.b[1][0]++;cov_zxu4rfsu7.s[8]++;return;}else{cov_zxu4rfsu7.b[1][1]++;}cov_zxu4rfsu7.s[9]++;clearInterval(this.timer);cov_zxu4rfsu7.s[10]++;this.timer=undefined;}updateDirtyNotes(){cov_zxu4rfsu7.f[3]++;const notes=(cov_zxu4rfsu7.s[11]++,this.realtime.getNotePool());cov_zxu4rfsu7.s[12]++;Object.keys(notes).forEach(key=>{cov_zxu4rfsu7.f[4]++;const note=(cov_zxu4rfsu7.s[13]++,notes[key]);cov_zxu4rfsu7.s[14]++;this.updateDirtyNote(note).catch(err=>{cov_zxu4rfsu7.f[5]++;cov_zxu4rfsu7.s[15]++;logger.error('updateDirtyNote: updater error',err);});});}async updateDirtyNote(note){cov_zxu4rfsu7.f[6]++;const notes=(cov_zxu4rfsu7.s[16]++,this.realtime.getNotePool());cov_zxu4rfsu7.s[17]++;if(!note.server.isDirty){cov_zxu4rfsu7.b[2][0]++;cov_zxu4rfsu7.s[18]++;return;}else{cov_zxu4rfsu7.b[2][1]++;}cov_zxu4rfsu7.s[19]++;if(config.debug){cov_zxu4rfsu7.b[3][0]++;cov_zxu4rfsu7.s[20]++;logger.info('updateDirtyNote: updater found dirty note: '+note.id);}else{cov_zxu4rfsu7.b[3][1]++;}cov_zxu4rfsu7.s[21]++;note.server.isDirty=false;cov_zxu4rfsu7.s[22]++;try{const _note=(cov_zxu4rfsu7.s[23]++,await this.updateNoteAsync(note));// handle when note already been clean up
cov_zxu4rfsu7.s[24]++;if((cov_zxu4rfsu7.b[5][0]++,!notes[note.id])||(cov_zxu4rfsu7.b[5][1]++,!notes[note.id].server)){cov_zxu4rfsu7.b[4][0]++;cov_zxu4rfsu7.s[25]++;return;}else{cov_zxu4rfsu7.b[4][1]++;}cov_zxu4rfsu7.s[26]++;if(!_note){cov_zxu4rfsu7.b[6][0]++;cov_zxu4rfsu7.s[27]++;this.realtime.io.to(note.id).emit('info',{code:404});cov_zxu4rfsu7.s[28]++;logger.error('updateDirtyNote: note not found: ',note.id);cov_zxu4rfsu7.s[29]++;this.realtime.disconnectSocketOnNote(note);}else{cov_zxu4rfsu7.b[6][1]++;}cov_zxu4rfsu7.s[30]++;note.updatetime=moment(_note.lastchangeAt).valueOf();cov_zxu4rfsu7.s[31]++;this.realtime.emitCheck(note);}catch(err){cov_zxu4rfsu7.s[32]++;logger.error('updateDirtyNote: note not found: ',note.id);cov_zxu4rfsu7.s[33]++;this.realtime.io.to(note.id).emit('info',{code:404});cov_zxu4rfsu7.s[34]++;this.realtime.disconnectSocketOnNote(note);cov_zxu4rfsu7.s[35]++;throw err;}}updateNoteAsync(note){cov_zxu4rfsu7.f[7]++;cov_zxu4rfsu7.s[36]++;return new Promise((resolve,reject)=>{cov_zxu4rfsu7.f[8]++;cov_zxu4rfsu7.s[37]++;this.realtime.updateNote(note,(err,_note)=>{cov_zxu4rfsu7.f[9]++;cov_zxu4rfsu7.s[38]++;if(err){cov_zxu4rfsu7.b[7][0]++;cov_zxu4rfsu7.s[39]++;return reject(err);}else{cov_zxu4rfsu7.b[7][1]++;}cov_zxu4rfsu7.s[40]++;return resolve(_note);});});}}cov_zxu4rfsu7.s[41]++;exports.UpdateDirtyNoteJob=UpdateDirtyNoteJob;