"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getFullName = getFullName;
exports.displayUsername = displayUsername;
exports.rolesIncludePermission = rolesIncludePermission;
exports.isAdmin = isAdmin;
exports.isTeamAdmin = isTeamAdmin;
exports.isSystemAdmin = isSystemAdmin;
exports.isChannelAdmin = isChannelAdmin;
exports.hasUserAccessTokenRole = hasUserAccessTokenRole;
exports.hasPostAllRole = hasPostAllRole;
exports.hasPostAllPublicRole = hasPostAllPublicRole;
exports.profileListToMap = profileListToMap;
exports.removeUserFromList = removeUserFromList;
exports.getSuggestionsSplitBy = getSuggestionsSplitBy;
exports.getSuggestionsSplitByMultiple = getSuggestionsSplitByMultiple;
exports.filterProfilesMatchingTerm = filterProfilesMatchingTerm;
exports.sortByUsername = sortByUsername;

require("core-js/modules/es6.array.from");

require("core-js/modules/es6.regexp.to-string");

require("core-js/modules/es7.symbol.async-iterator");

require("core-js/modules/es6.symbol");

require("core-js/modules/es6.string.starts-with");

require("core-js/modules/es6.array.iterator");

require("core-js/modules/es6.string.iterator");

require("core-js/modules/es6.set");

require("core-js/modules/web.dom.iterable");

require("core-js/modules/es7.array.includes");

require("core-js/modules/es6.string.includes");

require("core-js/modules/es6.regexp.split");

var _constants = require("../constants");

var _i18n_utils = require("./i18n_utils");

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

function getFullName(user
/*: UserProfile*/
)
/*: string*/
{
  if (user.first_name && user.last_name) {
    return user.first_name + ' ' + user.last_name;
  } else if (user.first_name) {
    return user.first_name;
  } else if (user.last_name) {
    return user.last_name;
  }

  return '';
}

function displayUsername(user
/*: UserProfile*/
, teammateNameDisplay
/*: string*/
)
/*: string*/
{
  var useFallbackUsername
  /*: boolean*/
  = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;
  var name = useFallbackUsername ? (0, _i18n_utils.localizeMessage)('channel_loader.someone', 'Someone') : '';

  if (user) {
    if (teammateNameDisplay === _constants.Preferences.DISPLAY_PREFER_NICKNAME) {
      name = user.nickname || getFullName(user);
    } else if (teammateNameDisplay === _constants.Preferences.DISPLAY_PREFER_FULL_NAME) {
      name = getFullName(user);
    } else {
      name = user.username;
    }

    if (!name || name.trim().length === 0) {
      name = user.username;
    }
  }

  return name;
}

function rolesIncludePermission(roles
/*: string*/
, permission
/*: string*/
)
/*: boolean*/
{
  var rolesArray = roles.split(' ');
  return rolesArray.includes(permission);
}

function isAdmin(roles
/*: string*/
)
/*: boolean*/
{
  return isSystemAdmin(roles) || isTeamAdmin(roles);
}

function isTeamAdmin(roles
/*: string*/
)
/*: boolean*/
{
  return rolesIncludePermission(roles, _constants.General.TEAM_ADMIN_ROLE);
}

function isSystemAdmin(roles
/*: string*/
)
/*: boolean*/
{
  return rolesIncludePermission(roles, _constants.General.SYSTEM_ADMIN_ROLE);
}

function isChannelAdmin(roles
/*: string*/
)
/*: boolean*/
{
  return rolesIncludePermission(roles, _constants.General.CHANNEL_ADMIN_ROLE);
}

function hasUserAccessTokenRole(roles
/*: string*/
)
/*: boolean*/
{
  return rolesIncludePermission(roles, _constants.General.SYSTEM_USER_ACCESS_TOKEN_ROLE);
}

function hasPostAllRole(roles
/*: string*/
)
/*: boolean*/
{
  return rolesIncludePermission(roles, _constants.General.SYSTEM_POST_ALL_ROLE);
}

function hasPostAllPublicRole(roles
/*: string*/
)
/*: boolean*/
{
  return rolesIncludePermission(roles, _constants.General.SYSTEM_POST_ALL_PUBLIC_ROLE);
}

function profileListToMap(profileList
/*: Array<UserProfile>*/
)
/*: IDMappedObjects<UserProfile>*/
{
  var profiles = {};

  for (var i = 0; i < profileList.length; i++) {
    profiles[profileList[i].id] = profileList[i];
  }

  return profiles;
}

function removeUserFromList(userId
/*: $ID<UserProfile>*/
, list
/*: Array<UserProfile>*/
)
/*: Array<UserProfile>*/
{
  for (var i = list.length - 1; i >= 0; i--) {
    if (list[i].id === userId) {
      list.splice(i, 1);
      return list;
    }
  }

  return list;
} // Splits the term by a splitStr and composes a list of the parts of
// the split concatenated with the rest, forming a set of suggesitons
// matchable with startsWith
//
// E.g.: for "one.two.three" by "." it would yield
// ["one.two.three", ".two.three", "two.three", ".three", "three"]


function getSuggestionsSplitBy(term
/*: string*/
, splitStr
/*: string*/
)
/*: Array<string>*/
{
  var splitTerm = term.split(splitStr);
  var initialSuggestions = splitTerm.map(function (st, i) {
    return splitTerm.slice(i).join(splitStr);
  });
  var suggestions = [];

  if (splitStr === ' ') {
    suggestions = initialSuggestions;
  } else {
    suggestions = initialSuggestions.reduce(function (acc, val) {
      if (acc.length === 0) {
        acc.push(val);
      } else {
        acc.push(splitStr + val, val);
      }

      return acc;
    }, []);
  }

  return suggestions;
}

function getSuggestionsSplitByMultiple(term
/*: string*/
, splitStrs
/*: Array<string>*/
)
/*: Array<string>*/
{
  var suggestions = splitStrs.reduce(function (acc, val) {
    getSuggestionsSplitBy(term, val).forEach(function (suggestion) {
      return acc.add(suggestion);
    });
    return acc;
  }, new Set());
  return _toConsumableArray(suggestions);
}

function filterProfilesMatchingTerm(users
/*: Array<UserProfile>*/
, term
/*: string*/
)
/*: Array<UserProfile>*/
{
  var lowercasedTerm = term.toLowerCase();
  var trimmedTerm = lowercasedTerm;

  if (trimmedTerm.startsWith('@')) {
    trimmedTerm = trimmedTerm.substr(1);
  }

  return users.filter(function (user
  /*: UserProfile*/
  ) {
    if (!user) {
      return false;
    }

    var profileSuggestions = [];
    var usernameSuggestions = getSuggestionsSplitByMultiple((user.username || '').toLowerCase(), _constants.General.AUTOCOMPLETE_SPLIT_CHARACTERS);
    profileSuggestions.push.apply(profileSuggestions, _toConsumableArray(usernameSuggestions));
    var first = (user.first_name || '').toLowerCase();
    var last = (user.last_name || '').toLowerCase();
    var full = first + ' ' + last;
    profileSuggestions.push(first, last, full);
    profileSuggestions.push((user.nickname || '').toLowerCase());
    var email = (user.email || '').toLowerCase();
    profileSuggestions.push(email);
    profileSuggestions.push((user.nickname || '').toLowerCase());
    var split = email.split('@');

    if (split.length > 1) {
      profileSuggestions.push(split[1]);
    }

    return profileSuggestions.filter(function (suggestion) {
      return suggestion !== '';
    }).some(function (suggestion) {
      return suggestion.startsWith(trimmedTerm);
    });
  });
}

function sortByUsername(a
/*: UserProfile*/
, b
/*: UserProfile*/
)
/*: number*/
{
  var nameA = a.username;
  var nameB = b.username;
  return nameA.localeCompare(nameB);
}